<script>
    function guessFilename(htmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        
        // 1. Try to find <title>
        let title = doc.querySelector('title')?.innerText;
        
        // 2. Fallback to first <h1> if title is empty/missing
        if (!title || title.trim() === "") {
            title = doc.querySelector('h1')?.innerText;
        }
        
        // 3. Clean the string for filesystem safety
        if (title) {
            return title
                .trim()
                .toLowerCase()
                .replace(/[åä]/g, 'a')
                .replace(/[ö]/g, 'o')
                .replace(/[^a-z0-9]/gi, '-') // Replace non-alphanumeric with hyphens
                .replace(/-+/g, '-')         // Remove double hyphens
                .substring(0, 50);           // Cap length
        }
        return "";
    }

    function updatePreview() {
        const code = document.getElementById('code-input').value;
        const iframe = document.getElementById('preview-frame');
        const filenameInput = document.getElementById('filename');
        
        // Update the visual preview
        iframe.srcdoc = code;

        // Guess the filename ONLY if the user hasn't typed one manually yet
        // or if the input is currently empty
        const guessedName = guessFilename(code);
        if (guessedName && (!filenameInput.dataset.userEdited)) {
            filenameInput.value = guessedName;
        }
    }

    // Track if the user manually changes the filename so we don't overwrite it
    document.getElementById('filename').addEventListener('input', (e) => {
        e.target.dataset.userEdited = "true";
    });

    function saveFile() {
        const code = document.getElementById('code-input').value;
        if (!code) { alert("Klistra in lite kod först!"); return; }
        
        let name = document.getElementById('filename').value || "pedagogiskt-verktyg";
        if (!name.endsWith('.html')) name += ".html";
        
        const blob = new Blob([code], { type: 'text/html' });
        const link = document.createElement('a');
        
        link.href = URL.createObjectURL(blob);
        link.download = name;
        link.click();
        
        URL.revokeObjectURL(link.href);
    }
</script>
